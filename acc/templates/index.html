<!DOCTYPE html>
<html>

<head>
  <meta charset='UTF-8'>
  <style>
    body {
      background: #f1f3f5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-family: sans-serif
    }

    body,
    html {
      margin: 0;
      padding: 0;
    }

    p {
      margin: 0;
    }

    .power-off {
      background: #f44336;
    }

    .power-off:hover {
      background: #ab1409;
    }


    .power-on {
      background: #009900;
    }

    .power-on:hover {
      background: #006b00;
    }

    .hidden {
      display: none;
    }

    .visible {
      display: inline-block;
    }

    #form-wrapper {
      display: flex;
    }

    .page {
      margin: 0 auto;
    }

    .page-container {
      margin-top: 40px;
      margin-right: auto;
      margin-bottom: 0;
      margin-left: auto;
      display: flex;
      max-width: 1080px;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .page-content {
      min-width: 480px;
    }

    #form-wrapper {
      display: flex;
      flex-direction: column;
    }

    #form-wrapper,
    form {
      width: 100%;
      background: #ffffff;
      box-sizing: border-box;
    }

    form {
      padding: 20px;
    }

    .form-section {
      display: flex;
      flex-direction: column;
    }

    .form-section+.form-section {
      margin-top: 18px;
    }

    .form-section input[type=number] {
      outline: none;
      display: block;
      background: rgba(0, 0, 0, 0.1);
      width: 100%;
      border: 0;
      border-radius: 4px;
      box-sizing: border-box;
      padding: 12px 20px;
      color: rgba(0, 0, 0, 0.6);
      font-family: inherit;
      font-size: inherit;
      font-weight: 500;
      line-height: inherit;
      transition: 0.3s ease;
    }

    .form-section input[type=submit] {
      width: 100%;
    }

    button,
    .form-section input[type=submit] {
      margin-top: 10px;
      outline: none;
      background: #4285F4;
      border: 0;
      border-radius: 4px;
      padding: 12px 20px;
      color: #FFFFFF;
      font-family: inherit;
      font-size: inherit;
      font-weight: 500;
      line-height: inherit;
      text-transform: uppercase;
      cursor: pointer;
    }

    .system-content {
      position: relative;
      display: flex;
      justify-content: space-between;
    }

    .system-content-item {
      display: flex;
      flex-direction: column;
      position: relative;
    }

    #system-info {
      position: relative;
    }

    .close {
      cursor: pointer;
      color: #aaaaaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    #settings-status {
      display: none;
    }

    input[type=submit]:hover,
    button:hover {
      background: #0b4bb6;
    }
  </style>

</head>

<body>
  <div class='page'>
    <div class='page-container'>
      <div class='page-content'>
        <div id='form-wrapper'>
          <form enctype='application/json' id='form' method='POST'>
            <div class='form-section'>
              <label for='speed'>SPEED</label>
              <input type='number' id='speed' name='speed'>
            </div>
            <div class='form-section'>
              <label for='distance'>SAFE DISTANCE</label>
              <input type='number' id='distance' name='distance'>
            </div>
            <div class='form-section'>
              <input type='submit' value='SUBMIT'>
            </div>
          </form>
          <div id='settings-status'></div>
        </div>
        <div class='system-content'>
          <div class='system-content-item'>
            <button id='display-info'>Display System Information</button>
            <div class='hidden' id='system-info'>
              <p>System information</p>
              <div id='display-info-content'></div>
            </div>
          </div>
          <div class='system-content-item'>
            <button class='power-on' id='powerSwitch'>Power On</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!--
    handles the functionality when the user submits the form
    sends POST request to /api/form
  -->
  <script type='text/javascript'>
    const form = document.getElementById('form');
    const url = 'http://localhost:8080/api/user-settings';
    const settings_status = document.getElementById('settings-status');

    /**
     create timeout variable, and clear on submit if a previous
     timeout has been set, so the timeout is refreshed
     */
    let timeout;
    const removeSettingStatus = () => {
      timeout = setTimeout(() => {
        settings_status.style.display = 'none';
      }, 5000);
    };

    form.onsubmit = (event) => {
      clearTimeout(timeout);
      event.preventDefault();
      const formSpeed = document.getElementById('speed').value;
      const formDistance = document.getElementById('distance').value;

      // settings_status.innerHTML = '';
      // settings_status.style.color = '';
      // settings_status.style.display = 'none';



      if (formSpeed.length !== 0 && formDistance.length !== 0) {
        const numSpeed = parseInt(formSpeed);
        const numDistance = parseInt(formDistance);
        const form_data = {
          "speed": numSpeed,
          "distance": numDistance
        }

        /**
          send user settings to api
         */
        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(form_data)
        }).then(res => {
          settings_status.innerHTML = 'Settings have been sent to GoPiGo'
          settings_status.style.display = 'block';
          removeSettingStatus();
        })
      } else {
        settings_status.innerHTML = 'Settings must not be empty';
        settings_status.style.color = '#f44336';
        settings_status.style.display = 'block';
        removeSettingStatus();
      }
    };
  </script>

  <!--
    handles the functionality when the user selects the power off button
  -->
  <script type='text/javascript'>
    const power_switch = document.getElementById('powerSwitch');
    power_switch.onclick = (event) => {
      event.preventDefault();
      const url = 'http://localhost:8080/api/power-status';

      /**
        fetch the current power setting and negate, then post
        to the api
      */
      fetch(url, {
        method: 'GET',
        headers: {
          'Accept': 'application/json'
        }
      })
        .then(res => res.json())
        .then(json => {
          const data = {
            'power': !json.power
          };
          return fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          })
            .then(res => res.json())
            .then(power => {
              if (power) {
                if (power_switch.className === 'power-on') {
                  power_switch.className = 'power-off';
                  power_switch.innerHTML = 'Power Off';
                }
              } else {
                if (power_switch.className === 'power-off') {
                  power_switch.className = 'power-on';
                  power_switch.innerHTML = 'Power On';
                }
              }
            })
        })
        .catch(err => {
          console.log('ERROR: ', err)
        });
    };
  </script>

  <!--
    handles the functionality of when the user selects the system information button
  -->
  <script type='text/javascript'>
    const display = document.getElementById('display-info');
    const system_info = document.getElementById('system-info');
    display.onclick = (event) => {
      event.preventDefault();
      if (system_info.className === 'hidden') {
        const url = 'http://localhost:8080/api/user-settings';

        /**
          fetch the current user settings
         */
        fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        })
          .then(res => res.json())
          .then(json => {
            const display = document.getElementById('display-info-content');
            display.innerHTML = '';

            /**
              go through KV pairs, create div for each,
              and append to display information div
             */
            for (key in json) {
              if (json.hasOwnProperty(key)) {
                const div = document.createElement('div');
                div.innerHTML = key + ": " + json[key];
                display.appendChild(div);
              }
            }
            system_info.className = 'visible';
          })
          .catch(err => {
            console.log(err);
          });
      } else {
        system_info.className = 'hidden';
      }
    };
  </script>
</body>

</html>